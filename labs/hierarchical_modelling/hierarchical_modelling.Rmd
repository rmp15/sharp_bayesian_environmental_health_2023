---
title: "Hierarchical modelling"
subtitle: "SHARP Bayesian Modeling for Environmental Health Workshop"
author: "Theo Rashid, Elizaveta Semenova"
date: "August 2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```

```{r packages}
library(tidyverse)
library(nimble)

set.seed(2)
```

This task will involve taking the England or Italy data and fitting a really basic hierarchical model.
It will follow your basic:

- Full pooling
- No pooling
- Partial pooling

Aka radon model example. https://www.tensorflow.org/probability/examples/Multilevel_Modeling_Primer
The difference being our subgroups will be regions of England or Italy.

Load in the data

```{r}
library(here)
library(tidyverse)
library(geojsonsf)
library(sf)
```

```{r load data}
shp <- geojson_sf(here("data", "italy", "italy.geojson"))
data <- read_rds(here("data", "italy", "italy_mortality.rds"))
```

```{r}
data <- st_read(here("data", "england", "COVIDecoregression.shp"))
```

Estimate the regional prevalence/outcome at one point in time

## Full pooling model

Treat all regions the same and estimate a single national prevalence.

## No pooling model

Treat all regions separately and estimate each region separately with fixed effects.

## Partial pooling model

Varying intercepts model. Random effect grouping all regions.
Estimate hyperparamter sigma (explain how this is hierarchical)
Follow the Bayesian workflow – look at MCMC outputs, r-hat using `posterior`, traceplots using `bayesplot`

## A different prior on sigma for Bayesian workflow

Maybe try a different prior on sigma, something really weird/informative and wrong.
Run prior predictive simulation and show how it makes no sense
Fit the model and look at posterior
